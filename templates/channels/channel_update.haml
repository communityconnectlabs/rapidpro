-extends "smartmin/update.html"
-load i18n

-block title

  %h2
    {{ title }}

-block form-buttons
  .form-actions
    %input.btn.btn-primary{type:"submit", value:"{{ submit_button_name }}"}
    %a.btn{onclick:"javascript:history.go(-1)"}
      -trans "Cancel"

  {% if object.channel_type == "WCH" %}
  #ccl-web-surveyor
  {% endif %}

-block extra-style
  :css
    .form-group {
      margin-bottom:15px;
    }
    
    #id_welcome_message {
        min-height: 100px;
    }

    .welcome-message-languages a {
      display: inline-block;
      margin: 2px 0;
      padding: 0 10px;
      border-right: 1px solid #569D9B;
    }

    .ref-welcome-message-languages, .ref-input-placeholder-languages {
      max-width: 380px;
    }

    .ref-welcome-message-languages a, .ref-input-placeholder-languages a {
      padding: 0 10px 0 0;
      display: inline-block;
    }

    .ref-welcome-message-languages a:last-child, .ref-input-placeholder-languages a:last-child {
      border-right: none;
    }

    .ref-welcome-message-languages a.active, .ref-input-placeholder-languages a.active {
      color: #000000;
    }

    #s2id_id_google_font .select2-search-choice-close {
      left: 10px;
      right: auto;
      top: 9px;
    }

    #s2id_id_google_font.select2-allowclear .select2-chosen {
      margin-right: 0;
      margin-left: 25px;
    }

    .custom-collapsed-menu {
      margin: 0 0 20px 0;
    }

    .custom-collapsed-menu .collapsed-title {
      font-size: 16px;
      margin: 0 0 10px 0;
      display: block;
      font-weight: 700;
      text-decoration: none;
      color: #666;
    }

    .custom-collapsed-menu .collapsed-title:hover {
      text-decoration: none;
      color: #569D9B;
    }

    .custom-collapsed-menu.active .custom-collapsed-menu-fields {
      display: block;
    }

    .custom-collapsed-menu .custom-collapsed-menu-fields {
      display: none;
    }

{% block extra-script %}
<script src="{{ STATIC_URL }}js/jscolor.js"></script>
{% if object.channel_type == "WCH" %}
<script src="{{ widget_compiled_file }}" type="text/javascript"></script>
{% endif %}
:javascript
  function buildWebChat(welcomeMsgDict, inputTextDict) {
    var title = $("#id_title").val();
    var icon = "{{ object.config.logo }}";
    var welcomeMessage = $("#id_welcome_message_default").val();
    var inputTextPlaceholderValue = $("#id_inputtext_placeholder_default").val();
    var widgetBackgroundColor = "#" + $("#id_widget_bg_color").val();
    var chatHeaderBackgroundColor = "#" + $("#id_chat_header_bg_color").val();
    var chatHeaderTextColor = "#" + $("#id_chat_header_text_color").val();
    var automatedChatBackgroundColor = "#" + $("#id_automated_chat_bg").val();
    var automatedChatTextColor = "#" + $("#id_automated_chat_txt").val();
    var userChatBackgroundColor = "#" + $("#id_user_chat_bg").val();
    var userChatTextColor = "#" + $("#id_user_chat_txt").val();
    var logoStyle = $("#id_logo_style").val();
    var chatButtonHeight = parseInt($("#id_chat_button_height").val());
    var sidePadding = parseInt($("#id_side_padding").val());
    var bottomPadding = parseInt($("#id_bottom_padding").val());
    var sideOfScreen = $("#id_side_of_screen").val();
    var googleFont = $("#id_google_font").val();
    var welcomeMessageQuickReplies = $("#id_welcome_msg_quick_replies").val();
    welcomeMessageQuickReplies = welcomeMessageQuickReplies !== "" ? welcomeMessageQuickReplies.split(",") : [];

    window.renderSurveyor({
      socketUrl: '{{ websocket_url }}',
      channelUUID: '{{ object.uuid }}',
      title: title,
      autoOpen: true,
      hostApi: 'https://{{ hostname }}',
      icon: icon,
      welcomeMessage: welcomeMessage,
      welcomeMessageI18n: welcomeMsgDict,
      inputTextPlaceholder: inputTextPlaceholderValue,
      inputTextPlaceholderI18n: inputTextDict,
      welcomeMessageQuickReplies: welcomeMessageQuickReplies,
      theme: {
        widgetBackgroundColor: widgetBackgroundColor,
        chatHeaderBackgroundColor: chatHeaderBackgroundColor,
        chatHeaderTextColor: chatHeaderTextColor,
        automatedChatBackgroundColor: automatedChatBackgroundColor,
        automatedChatTextColor: automatedChatTextColor,
        userChatBackgroundColor: userChatBackgroundColor,
        userChatTextColor: userChatTextColor,
        logoStyle: logoStyle,
        chatButtonHeight: chatButtonHeight,
        sidePadding: sidePadding,
        bottomPadding: bottomPadding,
        sideOfScreen: sideOfScreen,
        googleFont: googleFont
      },
      meta: {
        icon: {
          width: {{ wch_logo_size.width }},
          height: {{ wch_logo_size.height }}
        }
      }
    }, 'ccl-web-surveyor');
  }
  (function($) {
    // change the value of the first option to be empty so that select2 placeholder works
    $('#id_country').children(":first").remove();

    $('#id_country').select2({
      // add this class the select2 if you want to look similar with other fields
      containerCssClass: 'select2-temba-field',
      placeholder: "{% trans 'Select a Country' %}"
    });

    useFontCheckbox("#id_allow_international");

    $('#id_google_font').select2({
      width: '370px',
      containerCssClass: 'select2-temba-field',
      placeholder: "{% trans 'Select a Google Font' %}",
      allowClear: true,
      minimumInputLength: 2
    });

    $('#id_theme').select2({
      width: '370px',
      containerCssClass: 'select2-temba-field',
      placeholder: "{% trans 'Select a theme' %}"
    });

    $('#id_logo_style').select2({
      width: '120px',
      containerCssClass: 'select2-temba-field',
      minimumResultsForSearch: Infinity
    });

    $('#id_auto_open').select2({
      width: '100px',
      containerCssClass: 'select2-temba-field',
      minimumResultsForSearch: Infinity
    });

    $('#id_side_of_screen').select2({
      width: '100px',
      containerCssClass: 'select2-temba-field',
      minimumResultsForSearch: Infinity
    });

    function updateFormActionAndSubmit() {
      $("#id_action_type").val("update_and_reload");
      $(".smartmin-form").submit();
    }

    function reformatWebChatUpdatePage() {

      // Position and Size

      $(".smartmin-form fieldset").prepend(`
        <div class='custom-collapsed-menu position-and-size'>
          <a href='javascript:;' class='collapsed-title'>
            <i class='icon-arrow-right-8'></i>
            Position and Size
          </a>
          <div class='custom-collapsed-menu-fields'></div>
        </div>
      `);

      $('.control-group.field_chat_button_height').appendTo('.custom-collapsed-menu.position-and-size .custom-collapsed-menu-fields');
      $('.control-group.field_side_padding').appendTo('.custom-collapsed-menu.position-and-size .custom-collapsed-menu-fields');
      $('.control-group.field_bottom_padding').appendTo('.custom-collapsed-menu.position-and-size .custom-collapsed-menu-fields');
      $('.control-group.field_side_of_screen').appendTo('.custom-collapsed-menu.position-and-size .custom-collapsed-menu-fields');
      $('.control-group.field_auto_open').appendTo('.custom-collapsed-menu.position-and-size .custom-collapsed-menu-fields');

      // Look and Feel

      $(".smartmin-form fieldset").prepend(`
        <div class='custom-collapsed-menu look-and-feel'>
          <a href='javascript:;' class='collapsed-title'>
            <i class='icon-arrow-right-8'></i>
            Look and Feel
          </a>
          <div class='custom-collapsed-menu-fields'></div>
        </div>
      `);

      $('.control-group.field_theme').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_widget_bg_color').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_chat_header_bg_color').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_chat_header_text_color').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_automated_chat_bg').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_automated_chat_txt').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_user_chat_bg').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_user_chat_txt').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');
      $('.control-group.field_google_font').appendTo('.custom-collapsed-menu.look-and-feel .custom-collapsed-menu-fields');

      // Welcome Message

      $(".smartmin-form fieldset").prepend(`
        <div class='custom-collapsed-menu welcome-message'>
          <a href='javascript:;' class='collapsed-title'>
            <i class='icon-arrow-right-8'></i>
            Welcome Message
          </a>
          <div class='custom-collapsed-menu-fields'></div>
        </div>
      `);

      $('.control-group.field_welcome_message_default').appendTo('.custom-collapsed-menu.welcome-message .custom-collapsed-menu-fields');
      {% for lang in languages %}
        $('.control-group.field_welcome_message_{{ lang.iso_code }}').appendTo('.custom-collapsed-menu.welcome-message .custom-collapsed-menu-fields');
      {% endfor %}

      $('.control-group.field_inputtext_placeholder_default').appendTo('.custom-collapsed-menu.welcome-message .custom-collapsed-menu-fields');
      {% for lang in languages %}
        $('.control-group.field_inputtext_placeholder_{{ lang.iso_code }}').appendTo('.custom-collapsed-menu.welcome-message .custom-collapsed-menu-fields');
      {% endfor %}

      $('.control-group.field_welcome_msg_quick_replies').appendTo('.custom-collapsed-menu.welcome-message .custom-collapsed-menu-fields');

      // Setup

      $(".smartmin-form fieldset").prepend(`
        <div class='custom-collapsed-menu setup'>
          <a href='javascript:;' class='collapsed-title' id='link-menu-setup'>
            <i class='icon-arrow-down-2'></i>
            WebChat Setup
          </a>
          <div class='custom-collapsed-menu-fields'></div>
        </div>
      `);
      $('.control-group.field_name').appendTo('.custom-collapsed-menu.setup .custom-collapsed-menu-fields');
      $('.control-group.field_alert_email').appendTo('.custom-collapsed-menu.setup .custom-collapsed-menu-fields');
      $('.control-group.field_logo').appendTo('.custom-collapsed-menu.setup .custom-collapsed-menu-fields');
      $('.control-group.field_logo_style').appendTo('.custom-collapsed-menu.setup .custom-collapsed-menu-fields');
      $('.control-group.field_title').appendTo('.custom-collapsed-menu.setup .custom-collapsed-menu-fields');

      var errorsLenght = $("ul.errorlist").length;
      if (errorsLenght == 0) {
        $(".custom-collapsed-menu.setup").addClass("active");
      }
    }

    // adding languages to the form
    {% if object.channel_type == "WCH" %}
    $(document).ready(function() {
      reformatWebChatUpdatePage();

      $("ul.errorlist").each(function(idx, el) {
        $(el.parentNode.parentNode.parentNode.parentNode.parentNode).find("a.collapsed-title").find("i").attr("class", "icon-arrow-down-2");
        $(el.parentNode.parentNode.parentNode.parentNode.parentNode).find(".custom-collapsed-menu-fields").slideDown();
      });

      $('#id_welcome_msg_quick_replies').select2({
        tags: [],
        tokenSeparators: [","],
        minimumResultsForSearch: -1,
        placeholder: "Add quick replies to the welcome message",
        containerCssClass: "select2-temba-field"
      });

      $(".custom-collapsed-menu .collapsed-title").click(function() {
        var el = $(this).parent().find(".custom-collapsed-menu-fields");
        $(".custom-collapsed-menu-fields").slideUp();
        $(".custom-collapsed-menu").find("a.collapsed-title").find("i").attr("class", "icon-arrow-right-8");
        el.parent().find("a.collapsed-title").find("i").attr("class", "icon-arrow-down-2");
        el.slideDown();
      });

      buildGoogleFontLink($("#id_google_font").val());

      var updateChangesBtn = document.createElement("a");
      updateChangesBtn.className = "btn btn-primary";
      updateChangesBtn.onclick = function() { updateFormActionAndSubmit(); };
      updateChangesBtn.innerHTML = "{% trans 'Save and Update Widget' %}"
      $(".form-actions").prepend(updateChangesBtn);

      {% for item in customable_fields %}
      $("{{ item }}").blur(function() {
        buildWebChat();
      });
      {% endfor %}

      $("#id_side_of_screen").change(function() {
        buildWebChat();
      });

      $("#id_logo_style").change(function() {
        buildWebChat();
      });

      $("#id_google_font").change(function() {
        buildWebChat();
        buildGoogleFontLink($("#id_google_font").val());
      });

      var allLanguages = [{"iso_code": "default", "name": "Default"}];
      var welcomeMsgValues = {};
      var inputTextPlaceholderValues = {};

      {% for lang in languages %}
      allLanguages.push({"iso_code": "{{ lang.iso_code }}", "name": "{{ lang.name }}"});
      welcomeMsgValues["{{ lang.iso_code }}"] = document.getElementById("id_welcome_message_{{ lang.iso_code }}").value;
      inputTextPlaceholderValues["{{ lang.iso_code }}"] = document.getElementById("id_inputtext_placeholder_{{ lang.iso_code }}").value;
      {% endfor %}

      buildWebChat(welcomeMsgValues, inputTextPlaceholderValues);

      var divLanguages;
      var welcomeMessageField;
      var allDivLanguages = [];

      var divLanguagesInputPlaceholder;
      var inputPlaceholderField;
      var allDivLanguagesInputPlaceholder = [];

      for (lang in allLanguages) {
        divLanguages = document.createElement("div");
        divLanguages.classList.add("welcome-message-languages-" + allLanguages[lang]["iso_code"]);
        divLanguages.classList.add("ref-welcome-message-languages");
        welcomeMessageField = document.getElementsByClassName("field_welcome_message_" + allLanguages[lang]["iso_code"]);
        welcomeMessageField[0].appendChild(divLanguages);
        allDivLanguages.push(divLanguages);

        divLanguagesInputPlaceholder = document.createElement("div");
        divLanguagesInputPlaceholder.classList.add("input-placeholder-languages-" + allLanguages[lang]["iso_code"]);
        divLanguagesInputPlaceholder.classList.add("ref-input-placeholder-languages");
        inputPlaceholderField = document.getElementsByClassName("field_inputtext_placeholder_" + allLanguages[lang]["iso_code"]);
        inputPlaceholderField[0].appendChild(divLanguagesInputPlaceholder);
        allDivLanguagesInputPlaceholder.push(divLanguagesInputPlaceholder);
      }

      for (divLang in allDivLanguages) {
        for (lang in allLanguages) {
          var divLangItem = document.createElement("a");
          divLangItem.href = "javascript:;";
          divLangItem.setAttribute("data-iso-code", allLanguages[lang]["iso_code"]);
          divLangItem.onclick = function() { changeLangField($(this)) };
          divLangItem.text = allLanguages[lang]["name"];
          if (lang == 0) {
            divLangItem.classList.add("active");
          }
          var divLangItemClone = divLangItem.cloneNode(true);
          allDivLanguages[divLang].appendChild(divLangItem);

          divLangItemClone.removeAttribute("data-iso-code");
          divLangItemClone.setAttribute("data-placeholder-iso-code", allLanguages[lang]["iso_code"]);
          divLangItemClone.onclick = function() { changeLangFieldInputPlaceholder($(this)); }

          allDivLanguagesInputPlaceholder[divLang].appendChild(divLangItemClone);
        }
      }

      $.each($("div[class^='control-group field_welcome_message_']"), function (index) {
        if (index !== 0) {
          $(this).addClass("hide");
        }
      });

      $.each($("div[class^='control-group field_inputtext_placeholder_']"), function (index) {
        if (index !== 0) {
          $(this).addClass("hide");
        }
      });

      $("input").removeAttr("required");
      $("textarea").removeAttr("required");

    });
    {% endif %}

  })(jQuery);

  function changeLangField(el) {
    $(".ref-welcome-message-languages a").removeClass("active");
    $("a[data-iso-code='" + el.data('iso-code') + "']").addClass("active");
    $("div[class^='control-group field_welcome_message_']").addClass('hide');
    $(".field_welcome_message_" + el.data('iso-code')).removeClass('hide');
  }

  function changeLangFieldInputPlaceholder(el) {
    $(".ref-input-placeholder-languages a").removeClass("active");
    $("a[data-placeholder-iso-code='" + el.data('placeholder-iso-code') + "']").addClass("active");
    $("div[class^='control-group field_inputtext_placeholder_']").addClass('hide');
    $(".field_inputtext_placeholder_" + el.data('placeholder-iso-code')).removeClass('hide');
  }

  function buildGoogleFontLink(fontName) {
    if (!fontName) {
      $("#google_font_preview").remove();
      return
    }
    var fullURL = `https://fonts.google.com/specimen/${fontName}`;
    $("#google_font_preview").remove();
    $(".field_google_font").append(`<span id="google_font_preview">Google Font preview at <a href="${fullURL}" target="_new">${fullURL}</a></span>`);
  }

{% endblock %}
